<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Recommendations</title>
</head>
<body>
    <h1>Spotify Recommendations</h1>
    <div id="player"></div>
    <div id="recommendations"></div>

    <script src="https://sdk.scdn.co/spotify-player.js"></script>
    <script>
        const getTokenFromUrl = () => {
            return window.location.hash
                .substring(1)
                .split('&')
                .reduce((acc, item) => {
                    if (item) {
                        const [key, value] = item.split('=');
                        acc[key] = decodeURIComponent(value);
                    }
                    return acc;
                }, {});
        };

        const token = getTokenFromUrl().access_token;
        window.location.hash = '';

        if (token) {
            initializePlayer(token);
        } else {
            console.error('No access token found');
        }

        async function initializePlayer(token) {
            try {
                const userInfo = await fetchUserInfo(token);
                if (!userInfo.product || userInfo.product !== 'premium') {
                    throw new Error('This functionality is restricted to premium users only');
                }

                window.onSpotifyWebPlaybackSDKReady = () => {
                    const player = new Spotify.Player({
                        name: 'Web Playback SDK Quick Start Player',
                        getOAuthToken: cb => { cb(token); }
                    });

                    player.addListener('initialization_error', ({ message }) => { console.error(message); });
                    player.addListener('authentication_error', ({ message }) => { console.error(message); });
                    player.addListener('account_error', ({ message }) => { console.error(message); });
                    player.addListener('playback_error', ({ message }) => { console.error(message); });

                    player.addListener('player_state_changed', state => { console.log(state); });

                    player.addListener('ready', async ({ device_id }) => {
                        console.log('Ready with Device ID', device_id);
                        playTrack(device_id, token);
                        const topTracks = await fetchTopTracks(token);
                        const recommendations = await fetchRecommendations(token, topTracks);
                        displayRecommendations(recommendations);
                        localStorage.setItem("spotifyUserInfo", JSON.stringify(userInfo));
                    });

                    player.addListener('not_ready', ({ device_id }) => {
                        console.log('Device ID has gone offline', device_id);
                    });

                    player.connect();
                };
            } catch (error) {
                console.error(error.message);
                alert(error.message);
            }
        }

        async function playTrack(device_id, token) {
            try {
                await fetch(`https://api.spotify.com/v1/me/player/play?device_id=${device_id}`, {
                    method: 'PUT',
                    body: JSON.stringify({ uris: ['spotify:track:4iV5W9uYEdYUVa79Axb7Rh'] }),
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });
            } catch (error) {
                console.error('Error playing track:', error);
            }
        }

        async function fetchUserInfo(token) {
            try {
                const response = await fetch('https://api.spotify.com/v1/me', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                return await response.json();
            } catch (error) {
                console.error('Error fetching user info:', error);
                throw error;
            }
        }

        async function fetchTopTracks(token) {
            try {
                const response = await fetch('https://api.spotify.com/v1/me/top/tracks', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                const data = await response.json();
                return data.items.map(track => track.id);
            } catch (error) {
                console.error('Error fetching top tracks:', error);
            }
        }

        async function fetchRecommendations(token, topTracks) {
            try {
                const seedTracks = topTracks.slice(0, 5).join(',');
                const response = await fetch(`https://api.spotify.com/v1/recommendations?seed_tracks=${seedTracks}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                return await response.json();
            } catch (error) {
                console.error('Error fetching recommendations:', error);
            }
        }

        function displayRecommendations(recommendations) {
            const recommendationsDiv = document.getElementById('recommendations');
            recommendations.tracks.forEach(track => {
                const trackElement = document.createElement('div');
                trackElement.textContent = `${track.name} by ${track.artists.map(artist => artist.name).join(', ')}`;
                recommendationsDiv.appendChild(trackElement);
            });
        }
    </script>
</body>
</html>
